<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time to Take</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{--accent:#2b7a78;--muted:#666;--bg:#f7f7f8}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
  header{background:linear-gradient(90deg,#fff 0%,#f1f6f6 100%); padding:20px 24px; box-shadow:0 1px 4px rgba(0,0,0,.06)}
  h1{margin:0; font-size:20px; color:var(--accent)}
  .container{max-width:980px; margin:26px auto; padding:18px}
  .card{background:#fff; border-radius:10px; padding:16px; box-shadow:0 6px 18px rgba(19,24,34,.04); margin-bottom:18px}
  form .row{display:flex; gap:10px; flex-wrap:wrap}
  label{display:block; font-size:13px; margin-bottom:6px; color:var(--muted)}
  input[type="text"], input[type="time"], input[type="search"]{padding:10px; border-radius:8px; border:1px solid #e3e6e6; min-width:160px; width:100%}
  button{background:var(--accent); color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer}
  button.ghost{background:transparent; color:var(--accent); border:1px solid #d6eaea}
  table{width:100%; border-collapse:collapse; margin-top:12px}
  th,td{padding:10px 8px; text-align:left; border-bottom:1px solid #f1f1f1; font-size:14px}
  .muted{color:var(--muted); font-size:13px}
  .pill{display:inline-block; padding:6px 8px; background:#eef7f7; border-radius:999px; color:var(--accent); font-weight:600; font-size:13px}
  .taken{color:green}
  .btn-small{padding:6px 8px; border-radius:8px; font-size:13px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .flex-between{display:flex; justify-content:space-between; align-items:center}
  /* Mobile tweaks */
  @media (max-width:700px){
    .row{flex-direction:column}
    table thead{display:none}
    table tr{display:block; margin-bottom:10px}
    table td{display:flex; justify-content:space-between}
    header, .container{padding:14px}
  }

  /* Pop-up modal styles */
  #popupOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #popupBox {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    max-width: 300px;
    text-align: center;
    box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  }
  #popupBox h3 { margin-top:0; color: var(--accent); }
  #popupBox button { margin-top: 14px; }
</style>
</head>
<body>
<header>
  <div class="container flex-between">
    <div>
      <h1>üíä Time to Take</h1>
      <div class="muted">Simple medicine reminders ‚Äî browser-based, private, no account needed</div>
    </div>
    <div>
      <button id="requestPermBtn" class="ghost">Enable Notifications</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2 style="margin-top:0">Add / Edit Medicine</h2>
    <form id="medForm">
      <div class="row">
        <div style="flex:2">
          <label for="name">Medicine name</label>
          <input id="name" type="text" placeholder="e.g. Paracetamol" required />
        </div>
        <div style="flex:1">
          <label for="dosage">Dosage / Notes</label>
          <input id="dosage" type="text" placeholder="e.g. 500 mg / after food" required />
        </div>
        <div style="flex:1">
          <label for="time">Time</label>
          <input id="time" type="time" required />
        </div>
        <div style="align-self:flex-end">
          <button id="saveBtn">Save</button>
          <button id="cancelEdit" type="button" class="ghost" style="display:none">Cancel</button>
        </div>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">Your Medicines</h2>
      <div class="controls">
        <input id="search" type="search" placeholder="Search medicines..." />
        <button id="clearAll" class="ghost">Clear All</button>
      </div>
    </div>

    <table id="medTable">
      <thead><tr><th>Name</th><th>Dosage</th><th>Time</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="emptyNote" class="muted" style="margin-top:12px">No medicines yet. Add one above to start getting reminders.</div>
  </section>

  <section class="card">
    <h2 style="margin-top:0">Today‚Äôs Log</h2>
    <div id="log" class="muted">No entries yet today.</div>
  </section>
</main>

<!-- Pop-up Modal -->
<div id="popupOverlay">
  <div id="popupBox">
    <h3>‚è∞ Time to Take</h3>
    <p id="popupText"></p>
    <button onclick="document.getElementById('popupOverlay').style.display='none'">OK</button>
  </div>
</div>

<!-- Alert sound -->
<audio id="alertSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>
(function(){
  const qs = s => document.querySelector(s);
  const STORAGE_KEY = 'time_to_take_v1';
  const nameInput = qs('#name'), dosageInput = qs('#dosage'), timeInput = qs('#time');
  const medTableBody = qs('#medTable tbody'), emptyNote = qs('#emptyNote');
  const saveBtn = qs('#saveBtn'), cancelEditBtn = qs('#cancelEdit'), searchInput = qs('#search');
  const requestPermBtn = qs('#requestPermBtn'), alertSound = qs('#alertSound');
  const popupOverlay = qs('#popupOverlay'), popupText = qs('#popupText');
  let meds = [], editingId = null, soundUnlocked = false;

  function todayIso(){return new Date().toISOString().slice(0,10);}
  function formatTime(hhmm){if(!hhmm)return'';const[d,m]=hhmm.split(':').map(Number);const t=new Date();t.setHours(d,m);return t.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});}
  function load(){try{meds=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{meds=[];}}
  function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(meds));}

  function render(filter=''){
    medTableBody.innerHTML='';
    const list=meds.filter(m=>m.name.toLowerCase().includes(filter.toLowerCase())).sort((a,b)=>a.time.localeCompare(b.time));
    emptyNote.style.display=list.length?'none':'block';
    list.forEach(m=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${m.name}</td><td>${m.dosage}</td><td><span class="pill">${formatTime(m.time)}</span></td>
      <td>${(m.isTakenToday&&m.lastTakenDate===todayIso())?'<span class="taken">‚úÖ Taken</span>':'<span class="muted">‚è∞ Pending</span>'}</td>
      <td><button class="btn-small" onclick="markTaken(${m.id})">Mark</button>
      <button class="btn-small ghost" onclick="startEdit(${m.id})">Edit</button>
      <button class="btn-small" onclick="deleteMed(${m.id})">Del</button></td>`;
      medTableBody.appendChild(tr);
    });
  }

  window.markTaken=id=>{
    const m=meds.find(x=>x.id===id);if(!m)return;m.isTakenToday=true;m.lastTakenDate=todayIso();save();render(searchInput.value);
  }
  window.startEdit=id=>{
    const m=meds.find(x=>x.id===id);if(!m)return;editingId=id;
    nameInput.value=m.name;dosageInput.value=m.dosage;timeInput.value=m.time;
    saveBtn.textContent='Update';cancelEditBtn.style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
  }
  window.deleteMed=id=>{if(confirm('Delete this medicine?')){meds=meds.filter(x=>x.id!==id);save();render(searchInput.value);}};

  function addMed(name,dosage,time){const id=Date.now();meds.push({id,name,dosage,time,isTakenToday:false,lastTakenDate:null,lastNotifiedDate:null});save();render(searchInput.value);}
  function updateMed(id,name,dosage,time){const m=meds.find(x=>x.id===id);if(!m)return;m.name=name;m.dosage=dosage;m.time=time;save();render(searchInput.value);}
  function cancelEdit(){editingId=null;qs('#medForm').reset();saveBtn.textContent='Save';cancelEditBtn.style.display='none';}

  qs('#medForm').onsubmit=e=>{
    e.preventDefault();
    const n=nameInput.value.trim(),d=dosageInput.value.trim(),t=timeInput.value;
    if(!n||!d||!t)return alert('Complete fields');
    if(editingId){updateMed(editingId,n,d,t);cancelEdit();}else{addMed(n,d,t);qs('#medForm').reset();}
  }
  cancelEditBtn.onclick=cancelEdit;
  searchInput.oninput=()=>render(searchInput.value);
  qs('#clearAll').onclick=()=>{if(confirm('Delete all?')){meds=[];save();render();}};

  // Notifications + popup
  async function checkNotifications(){
    if(!('Notification' in window)) return;
    if(Notification.permission!=='granted') return;
    const now=new Date(), hhmm=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const today=todayIso();
    meds.forEach(m=>{
      if(m.time===hhmm && m.lastNotifiedDate!==today && m.lastTakenDate!==today){
        showNotification(m);
        m.lastNotifiedDate=today;save();
      }
    });
  }

  function showNotification(m){
    const title=`Time to take: ${m.name}`;
    const body=`${m.dosage} ‚Äî scheduled at ${formatTime(m.time)}.`;
    try{new Notification(title,{body});}catch{}
    // Play sound (requires user interaction unlock)
    try{alertSound.currentTime=0;alertSound.play();}catch{}
    popupText.innerHTML=`<strong>${m.name}</strong><br>${m.dosage}<br>${formatTime(m.time)}`;
    popupOverlay.style.display='flex';
  }

  // Ask for notification permission
  async function requestPermission(){
    if(!('Notification' in window)){alert('Notifications not supported on this browser.');return;}
    try{
      const perm=await Notification.requestPermission();
      if(perm==='granted'){alert('Notifications enabled!');requestPermBtn.textContent='Notifications: Enabled';requestPermBtn.disabled=true;}
      else alert('Notifications denied or blocked.');
    }catch(e){console.error(e);}
  }
  requestPermBtn.onclick=requestPermission;

  // Unlock sound on first tap (mobile browsers block autoplay)
  document.body.addEventListener('click', ()=>{
    if(!soundUnlocked){
      alertSound.play().then(()=>{alertSound.pause();soundUnlocked=true;});
    }
  }, {once:true});

  function refreshPermBtn(){
    if(!('Notification' in window)){requestPermBtn.style.display='none';return;}
    if(Notification.permission==='granted'){requestPermBtn.textContent='Notifications: Enabled';requestPermBtn.disabled=true;}
  }

  load();render();refreshPermBtn();
  setInterval(checkNotifications,20000);

  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log('Service Worker registered'));
}

})();
</script>
</body>
</html>
