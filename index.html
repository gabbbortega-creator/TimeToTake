<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time to Take</title>
<style>
  :root{--accent:#2b7a78;--muted:#666;--bg:#f7f7f8}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
  header{background:linear-gradient(90deg,#fff 0%,#f1f6f6 100%); padding:20px 24px; box-shadow:0 1px 4px rgba(0,0,0,.06)}
  h1{margin:0; font-size:20px; color:var(--accent)}
  .container{max-width:980px; margin:26px auto; padding:18px}
  .card{background:#fff; border-radius:10px; padding:16px; box-shadow:0 6px 18px rgba(19,24,34,.04); margin-bottom:18px}
  form .row{display:flex; gap:10px; flex-wrap:wrap}
  label{display:block; font-size:13px; margin-bottom:6px; color:var(--muted)}
  input[type="text"], input[type="time"], input[type="search"]{padding:10px; border-radius:8px; border:1px solid #e3e6e6; min-width:160px}
  button{background:var(--accent); color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer}
  button.ghost{background:transparent; color:var(--accent); border:1px solid #d6eaea}
  table{width:100%; border-collapse:collapse; margin-top:12px}
  th,td{padding:10px 8px; text-align:left; border-bottom:1px solid #f1f1f1; font-size:14px}
  .muted{color:var(--muted); font-size:13px}
  .pill{display:inline-block; padding:6px 8px; background:#eef7f7; border-radius:999px; color:var(--accent); font-weight:600; font-size:13px}
  .taken{color:green}
  .btn-small{padding:6px 8px; border-radius:8px; font-size:13px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .flex-between{display:flex; justify-content:space-between; align-items:center}
  @media (max-width:700px){ .row{flex-direction:column} table thead{display:none} table tr{display:block; margin-bottom:10px} table td{display:flex; justify-content:space-between} }
</style>
</head>
<body>
<header>
  <div class="container flex-between">
    <div>
      <h1>üíä Time to Take</h1>
      <div class="muted">Simple medicine reminders ‚Äî browser-based, private, no account needed</div>
    </div>
    <div>
      <button id="requestPermBtn" class="ghost">Enable Notifications</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2 style="margin-top:0">Add / Edit Medicine</h2>
    <form id="medForm">
      <div class="row">
        <div style="flex:2; min-width:200px">
          <label for="name">Medicine name</label>
          <input id="name" type="text" placeholder="e.g. Paracetamol" required />
        </div>
        <div style="flex:1; min-width:150px">
          <label for="dosage">Dosage / Notes</label>
          <input id="dosage" type="text" placeholder="e.g. 500 mg / after food" required />
        </div>
        <div style="min-width:130px">
          <label for="time">Time</label>
          <input id="time" type="time" required />
        </div>
        <div style="align-self:flex-end">
          <button id="saveBtn">Save</button>
          <button id="cancelEdit" type="button" class="ghost" style="display:none">Cancel</button>
        </div>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="flex-between">
      <h2 style="margin:0">Your Medicines</h2>
      <div class="controls">
        <input id="search" type="search" placeholder="Search medicines..." />
        <button id="clearAll" class="ghost">Clear All</button>
      </div>
    </div>

    <table id="medTable" aria-live="polite">
      <thead>
        <tr><th>Name</th><th>Dosage</th><th>Time</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="emptyNote" class="muted" style="margin-top:12px">No medicines yet. Add one above to start getting reminders.</div>
  </section>

  <section class="card">
    <h2 style="margin-top:0">Today‚Äôs Log</h2>
    <div id="log" class="muted">No entries yet today.</div>
  </section>
</main>

<!-- Audio beep for alerts -->
<audio id="beep">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script>
(function(){
  // Utilities
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const STORAGE_KEY = 'time_to_take_v1';

  // Elements
  const nameInput = qs('#name');
  const dosageInput = qs('#dosage');
  const timeInput = qs('#time');
  const medForm = qs('#medForm');
  const medTableBody = qs('#medTable tbody');
  const emptyNote = qs('#emptyNote');
  const logEl = qs('#log');
  const saveBtn = qs('#saveBtn');
  const cancelEditBtn = qs('#cancelEdit');
  const searchInput = qs('#search');
  const clearAllBtn = qs('#clearAll');
  const requestPermBtn = qs('#requestPermBtn');
  const beep = qs('#beep');

  // App state
  let meds = []; // {id, name, dosage, time (HH:MM), isTakenToday: boolean, lastNotifiedDate: 'YYYY-MM-DD'}
  let editingId = null;

  // Load from localStorage
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      meds = raw ? JSON.parse(raw) : [];
    }catch(e){
      console.error('Failed to load storage', e);
      meds = [];
    }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(meds));
  }

  // Helpers: get today's iso date string
  function todayIso(){ return new Date().toISOString().slice(0,10); }

  // Render
  function render(filter=''){
    medTableBody.innerHTML = '';
    const list = meds
      .filter(m => m.name.toLowerCase().includes(filter.toLowerCase()))
      .sort((a,b) => a.time.localeCompare(b.time));

    if(list.length === 0){
      emptyNote.style.display = 'block';
    } else {
      emptyNote.style.display = 'none';
    }

    list.forEach(m => {
      const tr = document.createElement('tr');

      const nameTd = document.createElement('td');
      nameTd.textContent = m.name;

      const dosageTd = document.createElement('td');
      dosageTd.textContent = m.dosage;

      const timeTd = document.createElement('td');
      timeTd.innerHTML = `<span class="pill">${formatTime(m.time)}</span>`;

      const statusTd = document.createElement('td');
      const taken = m.isTakenToday && m.lastTakenDate === todayIso();
      statusTd.innerHTML = taken ? '<span class="taken">‚úÖ Taken</span>' : '<span class="muted">‚è∞ Pending</span>';

      const actionsTd = document.createElement('td');

      if(!taken){
        const takeBtn = document.createElement('button');
        takeBtn.className = 'btn-small';
        takeBtn.textContent = 'Mark as Taken';
        takeBtn.onclick = () => markTaken(m.id);
        actionsTd.appendChild(takeBtn);
      }

      const editBtn = document.createElement('button');
      editBtn.className = 'btn-small ghost';
      editBtn.style.marginLeft = '8px';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => startEdit(m.id);
      actionsTd.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-small';
      delBtn.style.marginLeft = '8px';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => { if(confirm('Delete this medicine?')) deleteMed(m.id); };
      actionsTd.appendChild(delBtn);

      tr.appendChild(nameTd);
      tr.appendChild(dosageTd);
      tr.appendChild(timeTd);
      tr.appendChild(statusTd);
      tr.appendChild(actionsTd);

      medTableBody.appendChild(tr);
    });

    renderLog();
  }

  function formatTime(hhmm){
    // hh:mm (24h) -> 12-hour display with AM/PM
    if(!hhmm) return '';
    const [hh, mm] = hhmm.split(':').map(Number);
    const date = new Date();
    date.setHours(hh, mm);
    return date.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});
  }

  // CRUD
  function addMed(name, dosage, time){
    const id = Date.now() + Math.floor(Math.random()*999);
    meds.push({id, name, dosage, time, isTakenToday:false, lastTakenDate:null, lastNotifiedDate:null});
    save(); render(searchInput.value);
  }

  function startEdit(id){
    const m = meds.find(x => x.id === id);
    if(!m) return;
    editingId = id;
    nameInput.value = m.name;
    dosageInput.value = m.dosage;
    timeInput.value = m.time;
    saveBtn.textContent = 'Update';
    cancelEditBtn.style.display = 'inline-block';
    window.scrollTo({top:0, behavior:'smooth'});
  }

  function cancelEdit(){
    editingId = null;
    medForm.reset();
    saveBtn.textContent = 'Save';
    cancelEditBtn.style.display = 'none';
  }

  function updateMed(id, name, dosage, time){
    const m = meds.find(x => x.id === id);
    if(!m) return;
    m.name = name; m.dosage = dosage; m.time = time;
    save(); render(searchInput.value);
  }

  function deleteMed(id){
    meds = meds.filter(x => x.id !== id);
    save(); render(searchInput.value);
  }

  function markTaken(id){
    const m = meds.find(x => x.id === id);
    if(!m) return;
    m.isTakenToday = true;
    m.lastTakenDate = todayIso();
    save(); render(searchInput.value);
  }

  // Log (simple)
  function renderLog(){
    const today = todayIso();
    const taken = meds.filter(m => m.lastTakenDate === today).sort((a,b)=>a.time.localeCompare(b.time));
    if(taken.length === 0) {
      logEl.textContent = 'No medicines marked as taken today.';
      return;
    }
    logEl.innerHTML = taken.map(t => `<div>‚Ä¢ <strong>${t.name}</strong> at ${formatTime(t.time)}</div>`).join('');
  }

  // Notifications: check every 20 seconds for due meds. Avoid double notify by lastNotifiedDate.
  async function checkNotifications(){
    if(!('Notification' in window)) return;
    const permission = Notification.permission;
    if(permission !== 'granted') return;

    const now = new Date();
    const hhmm = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
    const today = todayIso();

    meds.forEach(m => {
      if(m.time === hhmm){
        // only notify if not already notified today and not marked taken yet
        if(m.lastNotifiedDate !== today && !(m.lastTakenDate === today)){
          showNotification(m);
          m.lastNotifiedDate = today;
          save();
        }
      }
    });
  }

  function showNotification(m){
    // small notification and sound
    const title = `Time to take: ${m.name}`;
    const opts = {
      body: `${m.dosage} ‚Äî scheduled at ${formatTime(m.time)}.`,
      tag: 'time-to-take-' + m.id, // avoid stacking duplicates
      renotify: false,
      silent: true
    };
    try{
      new Notification(title, opts);
    }catch(e){
      console.warn('Notification failed', e);
    }
    // play beep (some browsers require user gesture)
    try { beep.currentTime = 0; beep.play(); } catch(e){ /* ignore */ }
  }

  // Request permission handler
  async function requestPermission(){
    if(!('Notification' in window)){
      alert('Your browser does not support notifications.');
      return;
    }
    try{
      const perm = await Notification.requestPermission();
      if(perm === 'granted'){
        alert('Notifications enabled. The website will notify you when it\'s time to take medicines (while the page is open).');
      } else {
        alert('Notifications denied ‚Äî you can still use the app but reminders won‚Äôt show.');
      }
    }catch(e){
      console.error(e);
    }
  }

  // Clear daily notifications: run at midnight to reset per-day flags (we track dates, so not necessary but keep light cleanup)
  function dailyCleanup(){
    const today = todayIso();
    // no heavy cleanup required; we rely on date fields
  }

  // Form submit
  medForm.addEventListener('submit', function(e){
    e.preventDefault();
    const name = nameInput.value.trim();
    const dosage = dosageInput.value.trim();
    const time = timeInput.value;
    if(!name || !dosage || !time) return alert('Complete the fields.');

    if(editingId){
      updateMed(editingId, name, dosage, time);
      cancelEdit();
    } else {
      addMed(name, dosage, time);
      medForm.reset();
    }
  });

  cancelEditBtn.addEventListener('click', cancelEdit);

  searchInput.addEventListener('input', () => render(searchInput.value));

  clearAllBtn.addEventListener('click', () => {
    if(confirm('Delete ALL medicines?')){ meds = []; save(); render(); }
  });

  requestPermBtn.addEventListener('click', requestPermission);

  // initial load + render
  load();
  render();

  // Start notification check loop (every 20 seconds)
  setInterval(checkNotifications, 20 * 1000);
  // Also check immediately on load
  setTimeout(checkNotifications, 2000);

  // Optional: show permission button state
  function refreshPermBtn(){
    if(!('Notification' in window)){
      requestPermBtn.style.display = 'none';
      return;
    }
    if(Notification.permission === 'granted'){
      requestPermBtn.textContent = 'Notifications: Enabled';
      requestPermBtn.classList.remove('ghost');
      requestPermBtn.disabled = true;
    } else {
      requestPermBtn.textContent = 'Enable Notifications';
      requestPermBtn.classList.add('ghost');
      requestPermBtn.disabled = false;
    }
  }
  refreshPermBtn();

  // When page becomes visible, re-render & check notifications (covers some missed seconds)
  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState === 'visible'){ render(searchInput.value); checkNotifications(); refreshPermBtn(); }
  });

  // Helpful tip: request notification permission on first user gesture
  window.addEventListener('click', function once(){
    refreshPermBtn();
    window.removeEventListener('click', once);
  }, {capture:true});

})();
</script>
</body>
</html>
